<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Travel</title>
    <!-- ÂºïÂÖ• Swiper ÁöÑ CSS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <!-- ÂºïÁî®Êàë‰ª¨Ëá™Â∑±ÁöÑÂ§ñÈÉ®Ê†∑ÂºèË°® -->
    <link rel="stylesheet" href="styleForIndex.css">
    <style>
        /* ADDED: Basic styling for the trip card to match the screenshot */
        .trip-card-container {
            background-color: #f6f0ff; /* Light purple background */
            border-radius: 22px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            color: #333;
            border: 1px solid #eadeff;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .trip-card-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }
        .trip-card-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: rgba(128, 128, 128, 0.1);
            color: #555;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-bottom: 12px;
        }
        .trip-card-title {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .trip-card-details {
            font-size: 1rem;
            color: #5c5c5c;
            line-height: 1.5;
        }
        .trip-card-footer {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }
        .trip-card-image-placeholder {
            position: absolute;
            right: 25px;
            bottom: 25px;
            width: 90px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
        }
         /* Simple SVG for the placeholder */
        .trip-card-image-placeholder svg {
            width: 80%;
            height: 80%;
            stroke: #d1d1d1;
            stroke-width: 0.5;
            fill: none;
        }
    </style>
</head>
<body>

    <!-- ======== ÂØºËà™Ê†è (HTML Unchanged) ======== -->
    <header class="navbar">
        <div class="container">
            <a href="#" class="logo">Roamark</a>
            <div class="hamburger-menu"><span></span><span></span><span></span></div>
            <nav class="nav-links">
                <a href="#exhibition">Home</a>
                <a href="#slider-container">Featured Topics</a>
                <a href="#my-trips">My Trips</a>
                <a href="#site-footer">Contact Us</a>
            </nav>
            <div class="nav-auth">
                <a href="login.html" class="login" id="nav-login-btn">Log in</a>
                <div id="nav-user-info" style="display:none;">
                    <span id="nav-user-name"></span>
                    <a href="#" id="logout-btn" style="margin-left:10px;">Log out</a>
                </div>
            </div>
        </div>
    </header>

    <!-- ======== Â±ïÁ§∫Âå∫ (HTML Unchanged) ======== -->
    <section id="exhibition" class="exhibition-section">
        <div class="exhibition-content">
            <h1>Explore the Beauty of the World with Roamark</h1>
            <p>Roamark is your personal travel curator ‚Äî 
                    helping you plan unforgettable journeys while leaving your mark on the world. From iconic landmarks to hidden gems, 
                    we empower explorers to map, save, and share every step of their adventures.</p>
            <a href="#slider-container" class="btn-explore">Start Exploring</a>
        </div>
    </section>

    <!-- ======== ‰∏ªÂÜÖÂÆπÂå∫ (HTML Unchanged) ======== -->
    <main>
        <div id="slider-container" class="container">
            <div class="section-header-interactive">
                <h2>Featured Topics</h2>
                <div class="search-container">
                    <input type="search" id="city-search-input" placeholder="Search for a city..."><button id="city-search-btn" aria-label="Search">üîç</button>
                </div>
            </div>
            <div class="swiper-container">
                <div class="swiper-wrapper">
                    <div class="swiper-slide" data-city="Tokyo" data-lat="35.6895" data-lon="139.6917" data-zoom="12"><img src="images/tokyo.png" alt="Tokyo"><div class="slide-caption">Tokyo</div></div>
                    <div class="swiper-slide" data-city="Osaka" data-lat="34.6937" data-lon="135.5023" data-zoom="12"><img src="images/osaka.png" alt="Osaka"><div class="slide-caption">Osaka</div></div>
                    <div class="swiper-slide" data-city="Kyoto" data-lat="35.0116" data-lon="135.7681" data-zoom="12"><img src="images/kyoto.png" alt="Kyoto"><div class="slide-caption">Kyoto</div></div>
                    <div class="swiper-slide" data-city="Tokyo" data-lat="35.6895" data-lon="139.6917" data-zoom="12"><img src="images/tokyo.png" alt="Tokyo"><div class="slide-caption">Tokyo</div></div>
                    <div class="swiper-slide" data-city="Osaka" data-lat="34.6937" data-lon="135.5023" data-zoom="12"><img src="images/osaka.png" alt="Osaka"><div class="slide-caption">Osaka</div></div>
                    <div class="swiper-slide" data-city="Kyoto" data-lat="35.0116" data-lon="135.7681" data-zoom="12"><img src="images/kyoto.png" alt="Kyoto"><div class="slide-caption">Kyoto</div></div>
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </div>
        <div id="my-trips" class="container">
            <div class="my-trips-header">
                <h2>My Trips</h2>
                <button id="add-trip-btn" title="Create a new trip">+</button>
            </div>
            <div id="my-trips-list">
                <p class="empty-trips-message" id="trips-empty-message">You have no trips yet. Click the '+' to add one!</p>
            </div>
        </div>
    </main>

    <!-- ======== È°µËÑö (HTML Unchanged) ======== -->
    <footer id="site-footer" class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column about-us">
                    <h3>About us</h3>
                    <p>Roamark is your personal travel curator ‚Äî 
                    helping you plan unforgettable journeys while leaving your mark on the world. From iconic landmarks to hidden gems, we empower explorers to map, save, and share every step of their adventures.</p></div>
                <div class="footer-column quick-links">
                    <h3>Quick links</h3>
                    <ul>
                        <li><a href="#exhibition">Home</a></li>
                        <li><a href="#slider-container">Featured Topics</a></li>
                        <li><a href="#">FAQs</a></li></ul></div>
                <div class="footer-column contact-us">
                    <h3>Contact Us</h3>
                    <ul>
                        <li>Tel:400-123-4567</li>
                        <li>Email:rqztian041007@gmai.com, alicestar1218@gmail.com, tcm2109570@gmail.com, yyu973542@gmail.com</li>
                        <li>Address: XMUM, 43900 Dengkil Selangor</li></ul></div>
            </div>
            <div class="footer-bottom"><p>¬© 2025 Roamark Travel Agency. All rights reserved.</p></div>
        </div>
    </footer>

    <!-- ======== Ë°åÁ®ãÂºπÁ™ó (HTML Unchanged) ======== -->
    <div id="trip-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">Create My Trip</div>
            <label>Where do you want to go?</label>
            <input id="trip-city" type="text" placeholder="Enter city">
            <label>How long do you want to go?</label>
            <div class="date-picker-group">
                <div class="date-picker-item"><div class="date-label">Departure date</div><input id="trip-date-from" type="date"></div>
                <div class="date-picker-item"><div class="date-label">Return date</div><input id="trip-date-to" type="date"></div>
            </div>
            <div class="modal-actions">
                <button id="trip-cancel">Cancel</button>
                <button id="trip-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Swiper JS -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <!-- ALL JAVASCRIPT IS NOW IN THIS SINGLE MODULE SCRIPT -->
    <script type="module">
        // Import all necessary functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc as firestoreDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase project configuration
        const firebaseConfig = {
          apiKey: "AIzaSyC3sKjdwDvlQnwDt7afXbbze6aRnQVjBv0",
          authDomain: "roamark-web.firebaseapp.com",
          projectId: "roamark-web",
          storageBucket: "roamark-web.appspot.com",
          messagingSenderId: "226236070878",
          appId: "1:226236070878:web:f551ac673b1749e72e3b4f"
        };

        // Initialize Firebase and Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Trip Management Helper Functions ---
        function calculateDateDifference(dateFrom, dateTo) {
            const from = new Date(dateFrom);
            const to = new Date(dateTo);
            if (isNaN(from) || isNaN(to) || to < from) return { days: 0, nights: 0 };
            const diffTime = to - from;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return { days: diffDays, nights: diffDays > 0 ? diffDays - 1 : 0 };
        }

        function getTripStatus(dateFrom, dateTo) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const from = new Date(dateFrom);
            const to = new Date(dateTo);
            if (to < today) return 'Trip ended.';
            if (from > today) return 'Trip not started.';
            return 'Trip in progress.';
        }
        
        // --- Renders all trips from FIRESTORE ---
        async function loadAndRenderTrips() {
            const tripsListContainer = document.getElementById('my-trips-list');
            const emptyMsg = document.getElementById('trips-empty-message');
            tripsListContainer.innerHTML = ''; 

            const userStr = localStorage.getItem('loggedInUser');
            if (!userStr) {
                tripsListContainer.appendChild(emptyMsg);
                emptyMsg.style.display = 'block';
                return;
            }
            const user = JSON.parse(userStr);

            try {
                const tripsRef = collection(db, "trips");
                const q = query(tripsRef, where("userEmail", "==", user.email));
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    tripsListContainer.appendChild(emptyMsg);
                    emptyMsg.style.display = 'block';
                } else {
                    emptyMsg.style.display = 'none';
                    querySnapshot.forEach((doc) => {
                        const trip = doc.data();
                        const tripId = doc.id;
                        const { days, nights } = calculateDateDifference(trip.dateFrom, trip.dateTo);
                        const status = getTripStatus(trip.dateFrom, trip.dateTo);
                        const fromDate = new Date(trip.dateFrom);
                        const toDate = new Date(trip.dateTo);

                        let poiCount = 0;
                        if (trip.dailyDetails) {
                            Object.values(trip.dailyDetails).forEach(day => {
                                poiCount += day.pois.length;
                            });
                        }

                        const card = document.createElement('div');
                        card.className = 'trip-card-container';
                        card.setAttribute('data-trip-id', tripId);
                        card.innerHTML = `
                            <div class="trip-card-status"> ‚óè ${status}</div>
                            <h3 class="trip-card-title">${trip.city} ${days} Days Trip</h3>
                            <div class="trip-card-details">
                                ${String(fromDate.getMonth() + 1).padStart(2, '0')}.${String(fromDate.getDate()).padStart(2, '0')} to ${String(toDate.getMonth() + 1).padStart(2, '0')}.${String(toDate.getDate()).padStart(2, '0')} ${days} days ${nights} nights <br>
                                ${poiCount} places
                            </div>
                            <div class="trip-card-footer">
                                <button class="trip-card-delete-btn" style="background:#e74c3c;color:#fff;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;">Delete</button>
                            </div>
                            <div class="trip-card-image-placeholder">
                               <svg viewBox="0 0 100 80"><circle cx="75" cy="20" r="10" /><path d="M 0 70 L 30 40 L 50 60 L 80 30 L 100 50 L 100 80 L 0 80 Z" /></svg>
                            </div>
                        `;

                        card.addEventListener('click', (e) => {
                            if (e.target.classList.contains('trip-card-delete-btn')) return;
                            window.location.href = `mytrip.html?tripId=${tripId}`;
                        });

                        card.querySelector('.trip-card-delete-btn').addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (confirm('Are you sure you want to delete this trip?')) {
                                try {
                                    await deleteDoc(firestoreDoc(db, "trips", tripId));
                                    card.remove();
                                } catch (err) {
                                    console.error("Failed to delete trip:", err);
                                    alert('Failed to delete trip.');
                                }
                            }
                        });

                        tripsListContainer.appendChild(card);
                    });
                }
            } catch (error) {
                console.error("Error fetching trips from Firestore: ", error);
                tripsListContainer.innerHTML = '<p>Could not load trips. Please try again later.</p>';
            }
        }

        // --- All remaining code runs after the DOM is loaded ---
        document.addEventListener('DOMContentLoaded', function () {
            // --- Navigation bar logic ---
            const hamburger = document.querySelector('.hamburger-menu');
            const navLinks = document.querySelector('.nav-links');
            const navAuth = document.querySelector('.nav-auth');
            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
                navAuth.classList.toggle('active');
            });

            // --- Login status check and UI update ---
            const loginBtn = document.getElementById('nav-login-btn');
            const userInfoDiv = document.getElementById('nav-user-info');
            const userNameSpan = document.getElementById('nav-user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const tripsEmptyMsg = document.getElementById('trips-empty-message');

            function updateAuthAndTrips() {
                const user = localStorage.getItem('loggedInUser');
                if (user) {
                    const userObj = JSON.parse(user);
                    loginBtn.style.display = 'none';
                    userInfoDiv.style.display = 'inline-block';
                    userNameSpan.textContent = userObj.fullName || userObj.email;
                    tripsEmptyMsg.textContent = "You have no trips yet. Click the '+' to add one!";
                } else {
                    loginBtn.style.display = 'inline-block';
                    userInfoDiv.style.display = 'none';
                    tripsEmptyMsg.textContent = "You haven't logged in yet. Please log in to create and view your trips.";
                }
                loadAndRenderTrips();
            }
            updateAuthAndTrips();

            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('loggedInUser');
                updateAuthAndTrips();
            });

            // --- Swiper logic ---
            const swiper = new Swiper('.swiper-container', {
                loop: true, loopedSlides: 3, slidesPerView: 1.5, spaceBetween: 10, centeredSlides: true,
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
                pagination: { el: '.swiper-pagination', clickable: true },
                breakpoints: { 768: { slidesPerView: 3, spaceBetween: 30 } }
            });

            document.querySelectorAll('.swiper-slide').forEach(slide => {
                slide.addEventListener('click', function () {
                    window.location.href = `detail.html?city=${encodeURIComponent(this.dataset.city)}&lat=${this.dataset.lat}&lon=${this.dataset.lon}&zoom=${this.dataset.zoom}`;
                });
            });
            
            // --- Trip Creation Modal Logic ---
            const addTripBtn = document.getElementById('add-trip-btn');
            const tripModal = document.getElementById('trip-modal');
            const tripCancel = document.getElementById('trip-cancel');
            const tripConfirm = document.getElementById('trip-confirm');
            const tripCity = document.getElementById('trip-city');
            const tripDateFrom = document.getElementById('trip-date-from');
            const tripDateTo = document.getElementById('trip-date-to');
            
            addTripBtn.onclick = () => {
                const user = localStorage.getItem('loggedInUser');
                if (!user) {
                    alert('You must log in to create your own trip.');
                    return;
                }
                tripModal.style.display = 'flex';
                tripCity.value = ''; tripDateFrom.value = ''; tripDateTo.value = '';
            };
            tripCancel.onclick = () => { tripModal.style.display = 'none'; };
            
            // ‚ñº‚ñº‚ñº THIS IS THE CORRECTED LOGIC ‚ñº‚ñº‚ñº
            tripConfirm.onclick = async () => {
                const city = tripCity.value.trim();
                const dateFrom = tripDateFrom.value;
                const dateTo = tripDateTo.value;
                if (!city || !dateFrom || !dateTo) { alert('Please fill in all fields'); return; }
                if (new Date(dateFrom) > new Date(dateTo)) { alert('Return date must be after departure date'); return; }

                const userStr = localStorage.getItem('loggedInUser');
                if (!userStr) { alert('Authentication error. Please log in again.'); return; }
                const user = JSON.parse(userStr);

                // 1. Create the initial dailyDetails structure
                const daysCount = calculateDateDifference(dateFrom, dateTo).days;
                const initialDailyDetails = {};
                for (let i = 1; i <= daysCount; i++) {
                    initialDailyDetails[`DAY ${i}`] = { pois: [], remark: "" };
                }

                try {
                    // 2. Add the new trip document to Firestore
                    const docRef = await addDoc(collection(db, "trips"), {
                        userEmail: user.email,
                        city: city,
                        dateFrom: dateFrom,
                        dateTo: dateTo,
                        dailyDetails: initialDailyDetails,
                        createdAt: new Date()
                    });

                    // 3. Redirect to mytrip.html with the new tripId
                    window.location.href = `mytrip.html?tripId=${docRef.id}`;

                } catch (error) {
                    console.error("Error creating trip in Firestore: ", error);
                    alert("Failed to create the trip. Please check your connection and try again.");
                }
            };
            
            tripModal.onclick = (e) => { if (e.target === tripModal) tripModal.style.display = 'none'; };

            // --- Search logic ---
            const searchInput = document.getElementById('city-search-input');
            const searchBtn = document.getElementById('city-search-btn');
            const performSearch = () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (!searchTerm) return;
                let foundSlide = false;
                for (let i = 0; i < swiper.slides.length; i++) {
                    const slide = swiper.slides[i];
                    const city = slide.dataset.city;
                    if (city && city.toLowerCase() === searchTerm) {
                        swiper.slideToLoop(parseInt(slide.dataset.swiperSlideIndex, 10));
                        foundSlide = true;
                        break; 
                    }
                }
                if (!foundSlide) alert('City not found in featured topics.');
            };
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') { event.preventDefault(); performSearch(); } });
        });
    </script>
</body>
</html>